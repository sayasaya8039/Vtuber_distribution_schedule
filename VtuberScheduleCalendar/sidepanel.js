import{r as x,u as v,j as e,s as k,g as N,a as I,b as T,d as A,c as E}from"./assets/store.js";function V(n){const t=n.trim();if(t.startsWith("UC")&&t.length>=24)return t.split(/[^a-zA-Z0-9_-]/)[0];const a=t.match(/youtube\.com\/channel\/(UC[a-zA-Z0-9_-]+)/);return a?a[1]:null}function L(){const[n,t]=x.useState(""),[a,c]=x.useState([]),[l,h]=x.useState(!1),{holodexApiKey:m,addVTuber:g,vtubers:p}=v(),f=async()=>{var j,b,s,u;if(!n.trim()||!m)return;const r=V(n);h(!0);try{if(r){const o=await fetch(`https://holodex.net/api/v2/channels/${r}`,{headers:{"X-APIKEY":m}});if(o.ok){const d=await o.json(),w={id:d.id,name:d.english_name||d.name,channelId:d.id,org:(j=d.org)!=null&&j.toLowerCase().includes("hololive")?"hololive":(b=d.org)!=null&&b.toLowerCase().includes("nijisanji")?"nijisanji":"indie",color:(s=d.org)!=null&&s.toLowerCase().includes("hololive")?"#00bfff":(u=d.org)!=null&&u.toLowerCase().includes("nijisanji")?"#ff6b6b":"#a855f7",avatarUrl:d.photo};c([w])}else c([])}else{const o=await k(m,n);c(o)}}catch(o){console.error("Search failed:",o),c([])}finally{h(!1)}},y=async r=>{await g(r),c(a.filter(j=>j.channelId!==r.channelId))},i=r=>p.some(j=>j.channelId===r);return e.jsxs("div",{className:"vtuber-search",children:[e.jsxs("div",{className:"search-input",children:[e.jsx("input",{type:"text",value:n,onChange:r=>t(r.target.value),onKeyDown:r=>r.key==="Enter"&&f(),placeholder:"VTuberå or YouTube URLè²¼ã£ã¦ã­!",disabled:!m}),e.jsx("button",{onClick:f,disabled:l||!m,children:l?"æ¤œç´¢ä¸­...":"è¿½åŠ ã™ã‚‹"})]}),!m&&e.jsx("p",{className:"warning",children:"è¨­å®šã‹ã‚‰Holodex APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ã­"}),e.jsx("p",{className:"help-text-small",children:"VTuberåã§æ¤œç´¢ã€ã¾ãŸã¯YouTube URLã‚„ãƒãƒ£ãƒ³ãƒãƒ«ID(UCã§å§‹ã¾ã‚‹)ã‚’ç›´æ¥å…¥åŠ›"}),a.length>0&&e.jsx("div",{className:"search-results",children:a.map(r=>e.jsxs("div",{className:"search-result-item",children:[e.jsx("img",{src:r.avatarUrl||"/icons/icon48.png",alt:r.name,className:"avatar"}),e.jsxs("div",{className:"info",children:[e.jsx("span",{className:"name",children:r.name}),e.jsx("span",{className:"org",style:{color:r.color},children:r.org||"indie"})]}),e.jsx("button",{onClick:()=>y(r),disabled:i(r.channelId),children:i(r.channelId)?"è¿½åŠ æ¸ˆã¿":"è¿½åŠ "})]},r.channelId))})]})}function P(){const{vtubers:n,removeVTuber:t}=v();return n.length===0?e.jsxs("div",{className:"vtuber-list empty",children:[e.jsx("p",{children:"ğŸ­ ã¾ã VTuberãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“"}),e.jsx("p",{children:"ä¸Šã®æ¤œç´¢ã‹ã‚‰æ¨ã—ã‚’è¿½åŠ ã—ã‚ˆã†ï¼"})]}):e.jsxs("div",{className:"vtuber-list",children:[e.jsxs("h3",{children:["ç™»éŒ²æ¸ˆã¿VTuber (",n.length,")"]}),n.map(a=>e.jsxs("div",{className:"vtuber-item",children:[e.jsx("img",{src:a.avatarUrl||"/icons/icon48.png",alt:a.name,className:"avatar"}),e.jsxs("div",{className:"info",children:[e.jsx("span",{className:"name",children:a.name}),e.jsx("span",{className:"org-badge",style:{backgroundColor:a.color},children:a.org||"indie"})]}),e.jsx("button",{className:"remove-btn",onClick:()=>t(a.channelId),title:"å‰Šé™¤",children:"âœ•"})]},a.channelId))]})}const $="https://www.googleapis.com/calendar/v3";async function S(n=!0){return new Promise((t,a)=>{chrome.identity.getAuthToken({interactive:n},c=>{chrome.runtime.lastError?a(new Error(chrome.runtime.lastError.message)):c?t(c):a(new Error("Failed to get auth token"))})})}async function K(){const n=await S(!1).catch(()=>null);n&&await new Promise(t=>{chrome.identity.removeCachedAuthToken({token:n},t)})}async function _(n,t="primary"){var l;const a=await S(),c=await fetch(`${$}/calendars/${t}/events`,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify(n)});if(!c.ok){const h=await c.json();throw new Error(((l=h.error)==null?void 0:l.message)||"Failed to create event")}return c.json()}function U(n,t,a=30){const c=N(n),l=I(n),h=`https://www.youtube.com/watch?v=${n.id}`;return{summary:`ğŸ­ ${t.name} é…ä¿¡: ${n.title}`,description:`é…ä¿¡URL: ${h}

ãƒãƒ£ãƒ³ãƒãƒ«: ${n.channel.name}`,start:{dateTime:c.toISOString(),timeZone:"Asia/Tokyo"},end:{dateTime:l.toISOString(),timeZone:"Asia/Tokyo"},colorId:R(t.org),reminders:{useDefault:!1,overrides:[{method:"popup",minutes:a}]}}}function R(n){switch(n){case"hololive":return"9";case"nijisanji":return"11";case"indie":return"3";default:return"8"}}function C(n){return`vtuber_${n.id}_${n.start_scheduled||n.available_at}`}function D(){const{schedules:n,vtubers:t,loading:a,settings:c}=v(),[l,h]=x.useState(null),[m,g]=x.useState([]);x.useState(()=>{T().then(s=>g(s.syncedEventIds))});const p=[...n].sort((s,u)=>{const o=N(s).getTime(),d=N(u).getTime();return o-d}),f=async s=>{const u=t.find(o=>o.channelId===s.channel.id);if(u){h(s.id);try{const o=U(s,u,c.reminderMinutes);await _(o,c.calendarId);const d=C(s);await A(d),g(w=>[...w,d])}catch(o){console.error("Failed to add to calendar:",o),alert("ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¸ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ")}finally{h(null)}}},y=async()=>{for(const s of p){const u=C(s);m.includes(u)||await f(s)}},i=s=>m.includes(C(s)),r=s=>s.toLocaleString("ja-JP",{month:"numeric",day:"numeric",weekday:"short",hour:"2-digit",minute:"2-digit"}),j=s=>{const u=t.find(o=>o.channelId===s);return(u==null?void 0:u.color)||"#666"};if(a)return e.jsx("div",{className:"schedule-list loading",children:"èª­ã¿è¾¼ã¿ä¸­..."});if(n.length===0)return e.jsxs("div",{className:"schedule-list empty",children:[e.jsx("p",{children:"ğŸ“… ä»Šé€±ã®é…ä¿¡äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“"}),t.length===0&&e.jsx("p",{children:"VTuberã‚’è¿½åŠ ã—ã¦ãã ã•ã„"})]});const b=p.filter(s=>!i(s)).length;return e.jsxs("div",{className:"schedule-list",children:[e.jsxs("div",{className:"schedule-header",children:[e.jsxs("h3",{children:["é…ä¿¡äºˆå®š (",n.length,"ä»¶)"]}),b>0&&e.jsxs("button",{className:"sync-all-btn",onClick:y,children:["ğŸ“… å…¨ã¦è¿½åŠ  (",b,")"]})]}),p.map(s=>e.jsxs("div",{className:"schedule-item",style:{borderLeftColor:j(s.channel.id)},children:[e.jsx("div",{className:"schedule-time",children:s.status==="live"?e.jsx("span",{className:"live-badge",children:"ğŸ”´ LIVE"}):r(N(s))}),e.jsxs("div",{className:"schedule-info",children:[e.jsx("span",{className:"channel-name",children:s.channel.name}),e.jsx("span",{className:"title",children:s.title})]}),e.jsxs("div",{className:"schedule-actions",children:[e.jsx("a",{href:`https://www.youtube.com/watch?v=${s.id}`,target:"_blank",rel:"noopener noreferrer",className:"youtube-link",title:"YouTubeã§é–‹ã",children:"â–¶ï¸"}),e.jsx("button",{onClick:()=>f(s),disabled:l===s.id||i(s),title:i(s)?"è¿½åŠ æ¸ˆã¿":"ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ ",children:l===s.id?"â³":i(s)?"âœ“":"ğŸ“…"})]})]},s.id))]})}function M(){const{holodexApiKey:n,settings:t,setApiKey:a,updateSettings:c}=v(),[l,h]=x.useState(n),[m,g]=x.useState(!1),p=async()=>{await a(l),alert("APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ")},f=async()=>{try{await S(!0),g(!0),alert("Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«æ¥ç¶šã—ã¾ã—ãŸ")}catch(i){alert("æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: "+i.message)}},y=async()=>{await K(),g(!1),alert("æ¥ç¶šã‚’è§£é™¤ã—ã¾ã—ãŸ")};return e.jsxs("div",{className:"settings",children:[e.jsx("h3",{children:"âš™ï¸ è¨­å®š"}),e.jsxs("section",{className:"settings-section",children:[e.jsx("h4",{children:"Holodex API"}),e.jsxs("p",{className:"help-text",children:[e.jsx("a",{href:"https://holodex.net/login",target:"_blank",rel:"noopener noreferrer",children:"Holodex"}),"ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆå¾Œã€APIã‚­ãƒ¼ã‚’å–å¾—ã—ã¦ãã ã•ã„"]}),e.jsxs("div",{className:"input-group",children:[e.jsx("input",{type:"password",value:l,onChange:i=>h(i.target.value),placeholder:"Holodex APIã‚­ãƒ¼"}),e.jsx("button",{onClick:p,children:"ä¿å­˜"})]})]}),e.jsxs("section",{className:"settings-section",children:[e.jsx("h4",{children:"Google ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼"}),m?e.jsxs("div",{className:"connected",children:[e.jsx("span",{children:"âœ… æ¥ç¶šæ¸ˆã¿"}),e.jsx("button",{onClick:y,className:"disconnect-btn",children:"æ¥ç¶šè§£é™¤"})]}):e.jsx("button",{onClick:f,className:"connect-btn",children:"ğŸ”— Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«æ¥ç¶š"})]}),e.jsxs("section",{className:"settings-section",children:[e.jsx("h4",{children:"åŒæœŸè¨­å®š"}),e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",checked:t.autoSync,onChange:i=>c({autoSync:i.target.checked})}),"è‡ªå‹•åŒæœŸã‚’æœ‰åŠ¹ã«ã™ã‚‹"]}),e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",checked:t.notifyOnNewStream,onChange:i=>c({notifyOnNewStream:i.target.checked})}),"æ–°ã—ã„é…ä¿¡äºˆå®šã‚’é€šçŸ¥"]}),e.jsxs("div",{className:"input-group",children:[e.jsx("label",{children:"åŒæœŸé–“éš”ï¼ˆåˆ†ï¼‰"}),e.jsx("input",{type:"number",min:"15",max:"360",value:t.syncIntervalMinutes,onChange:i=>c({syncIntervalMinutes:Number(i.target.value)})})]}),e.jsxs("div",{className:"input-group",children:[e.jsx("label",{children:"ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ï¼ˆåˆ†å‰ï¼‰"}),e.jsx("input",{type:"number",min:"5",max:"120",value:t.reminderMinutes,onChange:i=>c({reminderMinutes:Number(i.target.value)})})]})]})]})}function G(){const[n,t]=x.useState("schedule"),{initialize:a,refreshSchedules:c,error:l}=v();x.useEffect(()=>{a()},[a]);const h=()=>{c()};return e.jsxs("div",{className:"side-panel",children:[e.jsxs("header",{className:"header",children:[e.jsx("h1",{children:"ğŸ­ VTuber Schedule"}),e.jsx("button",{onClick:h,className:"refresh-btn",title:"æ›´æ–°",children:"ğŸ”„"})]}),l&&e.jsxs("div",{className:"error-banner",children:["âš ï¸ ",l]}),e.jsxs("nav",{className:"tab-nav",children:[e.jsx("button",{className:n==="schedule"?"active":"",onClick:()=>t("schedule"),children:"ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«"}),e.jsx("button",{className:n==="vtubers"?"active":"",onClick:()=>t("vtubers"),children:"ğŸ­ VTuber"}),e.jsx("button",{className:n==="settings"?"active":"",onClick:()=>t("settings"),children:"âš™ï¸ è¨­å®š"})]}),e.jsxs("main",{className:"main-content",children:[n==="schedule"&&e.jsx(D,{}),n==="vtubers"&&e.jsxs(e.Fragment,{children:[e.jsx(L,{}),e.jsx(P,{})]}),n==="settings"&&e.jsx(M,{})]}),e.jsx("footer",{className:"footer",children:e.jsx("span",{children:"VTuber Schedule Calendar v1.0.0"})})]})}E.createRoot(document.getElementById("root")).render(e.jsx(x.StrictMode,{children:e.jsx(G,{})}));
