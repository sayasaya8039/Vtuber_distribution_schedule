const m="https://holodex.net/api/v2";chrome.runtime.onInstalled.addListener(()=>{console.log("VTuber Schedule Calendar installed"),l()});async function l(){const{settings:e}=await chrome.storage.sync.get("settings"),n=(e==null?void 0:e.syncIntervalMinutes)||60;chrome.alarms.create("syncSchedules",{periodInMinutes:n})}chrome.alarms.onAlarm.addListener(async e=>{e.name==="syncSchedules"&&await u()});async function u(){try{const e=await chrome.storage.sync.get(["holodexApiKey","vtubers","settings","syncedEventIds"]),n=e.holodexApiKey,t=e.vtubers||[],s=e.settings||{},r=e.syncedEventIds||[];if(!n||t.length===0||!s.autoSync)return;const h=t.map(c=>c.channelId).join(","),o=await fetch(`${m}/live?channels=${h}&status=upcoming,live&type=stream&limit=50`,{headers:{"X-APIKEY":n}});if(!o.ok)throw new Error(`Holodex API error: ${o.status}`);const i=await o.json(),a=i.filter(c=>{const d=`vtuber_${c.id}_${c.start_scheduled||c.available_at}`;return!r.includes(d)});s.notifyOnNewStream&&a.length>0&&g(a),console.log(`Synced ${i.length} schedules, ${a.length} new`)}catch(e){console.error("Sync error:",e)}}function g(e){const n=e.filter(r=>r.status==="upcoming").slice(0,3);if(n.length===0)return;const t=n.length===1?`${n[0].channel.name}の配信予定`:`${n.length}件の新しい配信予定`,s=n.map(r=>`${r.channel.name}: ${r.title}`).join(`
`);chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:t,message:s,priority:1})}chrome.runtime.onMessage.addListener((e,n,t)=>(y(e).then(t).catch(s=>t({success:!1,error:s.message})),!0));async function y(e){switch(e.type){case"SYNC_SCHEDULES":return await u(),{success:!0};case"GET_AUTH_TOKEN":return{success:!0,data:await new Promise((t,s)=>{chrome.identity.getAuthToken({interactive:!0},r=>{chrome.runtime.lastError?s(new Error(chrome.runtime.lastError.message)):r?t(r):s(new Error("No token"))})})};default:return{success:!1,error:"Unknown message type"}}}chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!1}).catch(e=>console.error(e));chrome.storage.onChanged.addListener((e,n)=>{n==="sync"&&e.settings&&l()});console.log("VTuber Schedule Calendar service worker started");
