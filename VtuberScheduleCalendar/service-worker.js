const y="https://holodex.net/api/v2",S="https://schedule.hololive.tv/lives/all",v="https://www.nijisanji.jp/streams",I="https://www.googleapis.com/calendar/v3";chrome.runtime.onInstalled.addListener(()=>{console.log("VTuber Schedule Calendar installed"),f(),setTimeout(()=>p(),5e3)});chrome.runtime.onStartup.addListener(()=>{console.log("VTuber Schedule Calendar started"),f(),setTimeout(()=>p(),1e4)});async function f(){const{settings:e}=await chrome.storage.sync.get("settings"),o=(e==null?void 0:e.syncIntervalMinutes)||60;await chrome.alarms.clear("syncSchedules"),chrome.alarms.create("syncSchedules",{delayInMinutes:1,periodInMinutes:o}),console.log("[Alarm] Set up: every "+o+" minutes")}chrome.alarms.onAlarm.addListener(async e=>{e.name==="syncSchedules"&&await p()});function w(e,o){const n=e.toLowerCase(),a=o.toLowerCase();return n.includes(a)||a.includes(n)}async function A(){try{const e=await fetch(S,{headers:{"User-Agent":"Mozilla/5.0",Accept:"text/html"}});if(!e.ok)return[];const o=await e.text(),n=[],a=/youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/g;let r;const c=new Set;for(;(r=a.exec(o))!==null;){const h=r[1];if(c.has(h))continue;c.add(h);const t=r.index,s=o.substring(t,Math.min(o.length,t+500)).match(/event_category['"]?\s*:\s*['"]([^'"]+)['"]/),i=s?s[1]:"Unknown";if(i==="Unknown")continue;const d=o.substring(t,Math.min(o.length,t+2e3)).match(/(\d{1,2}):(\d{2})/),g=new Date,m=new Date(g);d&&(m.setHours(parseInt(d[1]),parseInt(d[2]),0,0),m<g&&m.setDate(m.getDate()+1)),n.push({id:h,title:i+"ã®é…ä¿¡",type:"stream",start_scheduled:m.toISOString(),status:"upcoming",channel:{id:h,name:i,org:"Hololive"}})}return n}catch{return[]}}async function k(){var e,o;try{const n=await fetch(v,{headers:{"User-Agent":"Mozilla/5.0",Accept:"text/html"}});if(!n.ok)return[];const r=(await n.text()).match(/<script id="__NEXT_DATA__" type="application\/json">([^<]+)<\/script>/);if(!r)return[];const c=JSON.parse(r[1]);return(((o=(e=c==null?void 0:c.props)==null?void 0:e.pageProps)==null?void 0:o.streams)||[]).map(t=>{const s=(t.url||"").match(/v=([a-zA-Z0-9_-]{11})/),i=s?s[1]:t.id,l=t["youtube-channel"]||{};let d=l.name||"Unknown";return d=d.replace(/ã€ã«ã˜ã•ã‚“ã˜ã€‘/g,"").trim(),{id:i,title:t.title,type:"stream",start_scheduled:new Date(t["start-at"]).toISOString(),status:t.status==="on_air"?"live":"upcoming",channel:{id:l.id||i,name:d,org:"Nijisanji"}}})}catch{return[]}}async function T(e,o,n){try{const a=await new Promise((t,u)=>{chrome.identity.getAuthToken({interactive:!1},s=>{chrome.runtime.lastError||!s?u(new Error("Not authenticated")):t(s)})}),c=(await chrome.storage.sync.get(["syncedEventIds"])).syncedEventIds||[],h=[...c];for(const t of e.slice(0,5)){if(c.includes(t.id))continue;const u=o.find(g=>w(g.name,t.channel.name))||{id:t.channel.id,name:t.channel.name,channelId:t.channel.id,org:"other",color:"#888"},s=new Date(t.start_scheduled||t.available_at||Date.now()),i=new Date(s.getTime()+7200*1e3),l={summary:"ðŸŽ­ "+u.name+" é…ä¿¡: "+t.title,description:"é…ä¿¡URL: https://www.youtube.com/watch?v="+t.id,start:{dateTime:s.toISOString(),timeZone:"Asia/Tokyo"},end:{dateTime:i.toISOString(),timeZone:"Asia/Tokyo"},reminders:{useDefault:!1,overrides:[{method:"popup",minutes:n.reminderMinutes||30}]}};(await fetch(I+"/calendars/primary/events",{method:"POST",headers:{Authorization:"Bearer "+a,"Content-Type":"application/json"},body:JSON.stringify(l)})).ok&&(h.push(t.id),console.log("[Background] Added to calendar:",t.channel.name))}await chrome.storage.sync.set({syncedEventIds:h})}catch{console.log("[Background] Auto calendar add skipped (not authenticated)")}}async function p(){try{const e=await chrome.storage.sync.get(["holodexApiKey","vtubers","settings","knownScheduleIds"]),o=e.holodexApiKey,n=e.vtubers||[],a=e.settings||{},r=e.knownScheduleIds||[];if(!a.autoSync)return;const c=[];if(o&&n.length>0)try{const s=n.map(l=>l.channelId).join(","),i=await fetch(y+"/live?channels="+s+"&status=upcoming,live&type=stream&limit=50",{headers:{"X-APIKEY":o}});if(i.ok){const l=await i.json();c.push(...l)}}catch(s){console.error("Holodex fetch error:",s)}if(a.useHololiveScraper){const s=await A();if(a.showAllHololive)c.push(...s);else{const i=s.filter(l=>n.some(d=>w(d.name,l.channel.name)));c.push(...i)}}if(a.useNijisanjiScraper){const s=await k();if(a.showAllNijisanji)c.push(...s);else{const i=s.filter(l=>n.some(d=>w(d.name,l.channel.name)));c.push(...i)}}const h=c.filter((s,i,l)=>l.findIndex(d=>d.id===s.id)===i),t=h.filter(s=>!r.includes(s.id));a.notifyOnNewStream&&t.length>0&&(_(t,n),a.autoAddToCalendar&&await T(t,n,a));const u=[...new Set([...r,...h.map(s=>s.id)])].slice(-500);await chrome.storage.sync.set({knownScheduleIds:u}),console.log("[Background] Synced "+h.length+" schedules, "+t.length+" new")}catch(e){console.error("Sync error:",e)}}function _(e,o){const n=e.filter(c=>c.status==="upcoming").slice(0,3);if(n.length===0)return;const a=n.length===1?chrome.i18n.getMessage("notificationTitleSingle",[n[0].channel.name]):chrome.i18n.getMessage("notificationTitleMultiple",[String(n.length)]),r=n.map(c=>c.channel.name+": "+c.title).join(`
`);chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:a,message:r,priority:2})}chrome.runtime.onMessage.addListener((e,o,n)=>(E(e).then(n).catch(a=>n({success:!1,error:a.message})),!0));async function E(e){switch(e.type){case"SYNC_SCHEDULES":return await p(),{success:!0};case"GET_AUTH_TOKEN":return{success:!0,data:await new Promise((n,a)=>{chrome.identity.getAuthToken({interactive:!0},r=>{chrome.runtime.lastError?a(new Error(chrome.runtime.lastError.message)):r?n(r):a(new Error("No token"))})})};default:return{success:!1,error:"Unknown message type"}}}chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(e=>console.error(e));chrome.storage.onChanged.addListener((e,o)=>{o==="sync"&&e.settings&&f()});console.log("VTuber Schedule Calendar service worker started");
